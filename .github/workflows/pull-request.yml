---
# Tools that can save round-trips to github and a lot of time:
#
# yamllint -f parsable pull_request.yml
# pip3 install ruamel.yaml.cmd
# yaml merge-expand pull_request.yml exp.yml &&
#    diff -w -u pull_request.yml exp.yml
#
# github.com also has a powerful web editor that can be used without
# committing.

name: GitHub Actions

# yamllint disable-line rule:truthy
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# As of January 2021, no YAML anchors :-(
env:
  ubuntu_base_deps: doxygen make default-jre graphviz cmake ninja-build

jobs:

  build-basic:

    name: "build with requirements.txt"
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: setup env with requirements.txt
        run: |
          sudo apt-get -y install $ubuntu_base_deps
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          pip install -r scripts/requirements.txt

      - name: build doc
        run: ./.github/actions/build-sof-doc.sh

  build-lax:

    name: "build with requirements-lax.txt"
    runs-on: ubuntu-20.04
    # Makefile downgrades the Sphinx warnings, they are not errors any more
    env: {LAX: 1}
    steps:
      - uses: actions/checkout@v2

      - name: setup env with requirements-lax.txt
        run: |
          sudo apt-get update
          sudo apt-get -y install $ubuntu_base_deps
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          PIP_IGNORE_INSTALLED=0 pip install -r scripts/requirements-lax.txt

      # disable sphinx-build auto mode for sphinx-build < 1.7
      # disable plantUML output
      - name: config tweaks
        run: |
          # sphinx-build < 1.7 doesn't support "auto" and we're not sure
          # all default modules are "thread-safe"
          sed -i -e '/SPHINXBUILD/ s/-j *auto/-j 1/' Makefile
          # We don't want plantUML to raise the contribution bar
          sed -i -e 's/^\(plantuml_output_format *=\).*/\1 "none"/' conf.py

      - name: build doc
        run: ./.github/actions/build-sof-doc.sh
